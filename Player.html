<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WOO</title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="_icescrum_api.js"></script>
    <style>
      .code {
        font-family: "Courier New";
        font-weight: bolder;
        padding: 4px;
        margin: 2px;
      }

      .box {
        margin: 2px;
        padding: 2px;
        width: 40px;
        height: 40px;
        border: 1px solid grey;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Place l'élément en arrière-plan */

        background-image: url("officeicons.png");
        background-size: 36px 30px;
        background-repeat: repeat;
        opacity: 0.1; /* Contrôle l'opacité de l'élément */
      }
      body {
        background-color: azure;
      }
    </style>
  </head>
  <body>
    <div class="pl-5 m-2 mt-4 text-center">
      <div id="divBadConfig" class="container d-none text-left m-5 p-3 bg-warning">
        <h3>Oooops!!</h3>
        <p>
          Si vous voyez ce texte, c'est que cette page a besoin d'informations compémentaires de votre part pour
          fonctionner.
        </p>
        <p>
          Il faut un fichier nommé <span class="code">_icescrum_api.js</span> dans le dossier WOO: créez-le en recopiant
          et renommant <span class="code">_icescrum_api.js.example</span>
        </p>
        <p>Dans ce fichier, vous devez mettre:</p>
        <ol>
          <li>
            Votre token d'accès à l'API Icescrum. Cela donne quelque chose genre:
            <span class="code">var iceScrumToken = '91030e0ea9a9ab58...'</span>
            <p class="small text-secondary">
              Vous générez ou retrouvez votre token dans votre profil IceScrum ("My Account") sous l'onglet 'API token'
            </p>
          </li>
          <li>
            Votre code joueur dans `projectId`, soit:
            <span class="code">projectId = 'XXXXXX'</span>
          </li>
        </ol>
      </div>
    </div>
    <h1 id="heaProjectTitle"></h1>
    <div id="output" style="margin: 30px"></div>
    <div style="font-size: x-small">V1.0</div>
  </body>
</html>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // ============ Initialization =================
  var playerStories = []; // the title of the stories the player has taken into his project
  // we use the title because the id may have changed in the copy from master

  if (typeof API_base_url == "undefined")
    alert("L'adresse du serveur IceScrum n'est pas définie. Vérifiez votre configuration (comparez-la avec l'exemple)");

  // Init page using a single project ID
  if (typeof iceScrumToken !== "undefined" && typeof projectId !== "undefined") {
    loadProject();
  } else {
    divBadConfig.classList.remove("d-none");
  }

  async function loadProject() {
    heaProjectTitle.innerText = projectId;
    API_project_url = API_base_url + projectId;
    // Project name
    await fetch(API_project_url + "/?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(async function (data) {
        heaProjectTitle.innerText = data.name;
        // Build the list of stories the player already has
        await fetch(API_project_url + "/story?icescrum-token=" + iceScrumToken)
          .then(function (response) {
            return response.json();
          })
          .then(async function (stories) {
            // we only take the stories of sprint 1. This allows us to easily manage which stories are part of the game
            for (story of stories) {
              playerStories.push(story);
            }
          })
          .catch(function (erreur) {
            alert(
              "Erreur de connexion au serveur IceScrum\n\nSi internet est ok (=vous pouvez atteindre icescrum.cpnv.ch avec votre navigateur), alors c'est probablement que le code du projet est faux ou que votre token est pourri"
            );
            window.close();
          });
      });

    API_source_url = API_base_url + "WOOMASTER";
    output.innerHTML = "";
    // Project name
    fetch(API_source_url + "/?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(async function (data) {
        document.title = "WOO Player";
        appendContent(output);
      })
      .catch(function (erreur) {
        alert(
          "Erreur de connexion au serveur IceScrum\n\nSi internet est ok (=vous pouvez atteindre icescrum.cpnv.ch avec votre navigateur), alors c'est probablement votre token est pourri ou que le projet P_OFFICE de base (POFFICEMAS) n'est pas atteignable"
        );
        window.close();
      });
  }

  async function appendContent(output) {
    // Get all sprints
    await fetch(API_source_url + "/sprint?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(async function (sprints) {
        // we only take the stories of sprint 1. This allows us to easily manage which stories are part of the game
        for (story_id of sprints[0].stories_ids) {
          await appendStory(story_id.id, output);
        }
        // Add list of missions already taken at the bottom
        let t = document.createElement("h4");
        t.innerText = "Vos missions";
        output.appendChild(t);
        let ul = document.createElement("ul");
        for (story of playerStories) {
          let li = document.createElement("li");
          li.innerText = story.name;
          ul.appendChild(li);
        }
        output.appendChild(ul);
      })
      .catch(function (erreur) {
        console.log(erreur);
        alert(
          "Erreur de connexion au serveur IceScrum\n\nSi internet est ok (=vous pouvez atteindre icescrum.cpnv.ch avec votre navigateur), alors c'est probablement que le code du projet est faux ou que votre token est pourri"
        );
        //window.close();
      });
  }

  async function appendStory(storyid, output) {
    let storydiv = document.createElement("div");
    storydiv.classList.add("card", "shadow", "p-3", "mb-5", "bg-white", "rounded-lg");
    await fetch(API_source_url + "/story/" + storyid + "?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(async function (story) {
        if (!playerStories.find((s) => s.name === story.name)) {
          // header
          let header = document.createElement("div");
          header.classList.add("card-header");
          header.innerHTML = "<h5>" + story.name + "</h5>" + story.description;
          storydiv.appendChild(header);
          let tests = document.createElement("div");

          // body
          let p = document.createElement("p");
          p.innerHTML =
            'Vous obtiendrez <span class="badge badge-pill badge-success">' + story.effort + " px</span> si:";
          storydiv.appendChild(p);
          tests.classList.add("card-body");
          await appendTests(storyid, tests);
          storydiv.appendChild(tests);
          output.appendChild(storydiv);
          let btnCopy = document.createElement("div");
          btnCopy.classList.add("btn", "btn-primary", "btn-sm", "float-right");
          btnCopy.innerText = "Prendre";
          btnCopy.dataset.story_id = story.id;
          btnCopy.addEventListener("click", (evt) => takeStory(evt.target.dataset.story_id));
          tests.appendChild(btnCopy);
        }
      })
      .catch(function (err) {
        console.log(err);
      });
  }

  async function appendTests(storyid, output) {
    await fetch(API_source_url + "/acceptanceTest/story/" + story_id.id + "?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(function (tests) {
        let ul = document.createElement("ul");
        for (test of tests) {
          let para = document.createElement("li");
          para.innerText = test.description;
          ul.appendChild(para);
        }
        output.appendChild(ul);
      })
      .catch(function (err) {
        console.log(err);
      });
  }

  // The student takes on a mission, i.e: we copy the story from the master project to the student's project
  async function takeStory(story_id) {
    await fetch(API_source_url + "/story/" + story_id + "?icescrum-token=" + iceScrumToken)
      .then(function (response) {
        return response.json();
      })
      .then(async function (storysource) {
        delete storysource.feature; // because there's no matching feature in the destination project
        // copy the story with axios, works where fetch fails for an unknown reason
        let action = API_project_url + "/story/" + "?icescrum-token=" + iceScrumToken;
        await axios
          .post(
            action,
            {
              story: storysource
            },
            {
              "Content-Type": "application/json",
              Accept: "application/json"
            }
          )
          .then(function (response) {
            alert(response.notes_html);
          })
          .catch(function (error) {
            alert(error.response.data[0].text);
          });
      })
      .catch(function (err) {
        console.log("Problem: " + err);
      });
  }
</script>
